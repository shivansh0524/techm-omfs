<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Loan Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white p-10">
<h1 class="text-3xl font-bold mb-6">Admin Loan Report</h1>

<!-- Summary Counters -->
<div class="grid grid-cols-3 gap-6 mb-6">
    <div class="bg-gray-800 p-4 rounded-lg">
        <p>Total Applications</p>
        <p class="text-2xl" th:text="${total}">0</p>
    </div>
    <div class="bg-green-700 p-4 rounded-lg">
        <p>Approved</p>
        <p class="text-2xl" th:text="${approved}">0</p>
    </div>
    <div class="bg-red-700 p-4 rounded-lg">
        <p>Rejected</p>
        <p class="text-2xl" th:text="${rejected}">0</p>
    </div>
</div>

<!-- Filter Form -->
<form method="get" class="mb-4 space-y-2 bg-gray-800 p-4 rounded-lg">
    <div class="grid grid-cols-4 gap-4">
        <select name="status" class="p-2 rounded text-black">
            <option value="">All</option>
            <option value="APPROVED" th:selected="${selectedStatus == 'APPROVED'}">Approved</option>
            <option value="REJECTED" th:selected="${selectedStatus == 'REJECTED'}">Rejected</option>
            <option value="PENDING" th:selected="${selectedStatus == 'PENDING'}">Pending</option>
        </select>

        <select name="lenderId" class="p-2 rounded text-black">
            <option value="">All Lenders</option>
            <option th:each="l : ${lenders}"
                    th:value="${l.id}"
                    th:text="${l.name}"
                    th:selected="${selectedLenderId == l.id}">
            </option>
        </select>

        <input type="date" name="from" class="p-2 rounded text-black" th:value="${from}">
        <input type="date" name="to" class="p-2 rounded text-black" th:value="${to}">
    </div>
    <button type="submit" class="px-4 py-2 bg-blue-600 rounded">Filter</button>
</form>

<!-- Loan Table -->
<table class="table-auto w-full bg-gray-800 rounded-lg text-sm">
    <thead class="bg-gray-700 text-left">
    <tr>
        <th class="px-4 py-2">Name</th>
        <th class="px-4 py-2">Email</th>
        <th class="px-4 py-2">Status</th>
        <th class="px-4 py-2">Lender</th>
        <th class="px-4 py-2">Date</th>
        <th class="px-4 py-2">Action</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="c : ${customers}" class="border-t border-gray-600">
        <td class="px-4 py-2" th:text="${c.name}">Name</td>
        <td class="px-4 py-2" th:text="${c.email}">Email</td>
        <td class="px-4 py-2" th:text="${c.status}">Status</td>
        <td class="px-4 py-2" th:text="${c.lender != null ? c.lender.name : 'N/A'}">Lender</td>
        <td class="px-4 py-2" th:text="${c.date}">Date</td>
        <td class="px-4 py-2 space-y-2">
            <a th:href="@{/admin/loan-details/{id}(id=${c.id})}"
               class="text-blue-400 hover:underline block">View</a>

            <div th:if="${c.status == 'PENDING'}">
                <form th:action="@{/admin/approve/{id}(id=${c.id})}" method="post" class="inline">
                    <button type="submit" class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">Approve</button>
                </form>
                <form th:action="@{/admin/reject/{id}(id=${c.id})}" method="post" class="inline ml-1">
                    <button type="submit" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">Reject</button>
                </form>
            </div>

            <a th:href="@{/admin/download-pdf/{id}(id=${c.id})}"
               class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded block mt-1 text-center">
                Download PDF
            </a>
        </td>
    </tr>
    <tr th:if="${customers.isEmpty()}" class="text-center text-gray-400">
        <td colspan="6" class="py-4">No loan applications found.</td>
    </tr>
    </tbody>
</table>

<!-- Chart -->
<div class="mt-10 flex justify-center">
    <div class="w-full sm:w-2/3 md:w-1/2 lg:w-1/3">
        <canvas id="loanChart"></canvas>
    </div>
</div>

<!-- Chart Script -->
<script th:inline="javascript">
    const approved = [[${approved}]];
    const rejected = [[${rejected}]];
    const total = [[${total}]];
    const pending = total - approved - rejected;

    const ctx = document.getElementById('loanChart');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Approved', 'Rejected', 'Pending'],
            datasets: [{
                data: [approved, rejected, pending],
                backgroundColor: ['#16a34a', '#dc2626', '#fbbf24']
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        color: '#fff'
                    }
                }
            }
        }
    });
    /*]]>*/
</script>
</body>
</html>
